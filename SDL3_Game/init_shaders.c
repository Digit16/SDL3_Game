#include "init_shaders.h"
#include "shaderc/shaderc.h"
#include "string_view.h"

static const unsigned char testgpu_effects_grayscale_frag_spv[] = {
    0x03,
    0x02,
    0x23,
    0x07,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x0e,
    0x00,
    0x36,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x11,
    0x00,
    0x02,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x0b,
    0x00,
    0x06,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x47,
    0x4c,
    0x53,
    0x4c,
    0x2e,
    0x73,
    0x74,
    0x64,
    0x2e,
    0x34,
    0x35,
    0x30,
    0x00,
    0x00,
    0x00,
    0x00,
    0x0e,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x0f,
    0x00,
    0x08,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x6d,
    0x61,
    0x69,
    0x6e,
    0x00,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x00,
    0x00,
    0x10,
    0x00,
    0x03,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x03,
    0x00,
    0x05,
    0x00,
    0x00,
    0x00,
    0x58,
    0x02,
    0x00,
    0x00,
    0x05,
    0x00,
    0x06,
    0x00,
    0x06,
    0x00,
    0x00,
    0x00,
    0x74,
    0x79,
    0x70,
    0x65,
    0x2e,
    0x32,
    0x64,
    0x2e,
    0x69,
    0x6d,
    0x61,
    0x67,
    0x65,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x05,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x75,
    0x5f,
    0x74,
    0x65,
    0x78,
    0x74,
    0x75,
    0x72,
    0x65,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x06,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x74,
    0x79,
    0x70,
    0x65,
    0x2e,
    0x73,
    0x61,
    0x6d,
    0x70,
    0x6c,
    0x65,
    0x72,
    0x00,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x05,
    0x00,
    0x09,
    0x00,
    0x00,
    0x00,
    0x75,
    0x5f,
    0x73,
    0x61,
    0x6d,
    0x70,
    0x6c,
    0x65,
    0x72,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x06,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x69,
    0x6e,
    0x2e,
    0x76,
    0x61,
    0x72,
    0x2e,
    0x43,
    0x4f,
    0x4c,
    0x4f,
    0x52,
    0x30,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x07,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x69,
    0x6e,
    0x2e,
    0x76,
    0x61,
    0x72,
    0x2e,
    0x54,
    0x45,
    0x58,
    0x43,
    0x4f,
    0x4f,
    0x52,
    0x44,
    0x30,
    0x00,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x07,
    0x00,
    0x05,
    0x00,
    0x00,
    0x00,
    0x6f,
    0x75,
    0x74,
    0x2e,
    0x76,
    0x61,
    0x72,
    0x2e,
    0x53,
    0x56,
    0x5f,
    0x54,
    0x61,
    0x72,
    0x67,
    0x65,
    0x74,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x04,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x6d,
    0x61,
    0x69,
    0x6e,
    0x00,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x07,
    0x00,
    0x0a,
    0x00,
    0x00,
    0x00,
    0x74,
    0x79,
    0x70,
    0x65,
    0x2e,
    0x73,
    0x61,
    0x6d,
    0x70,
    0x6c,
    0x65,
    0x64,
    0x2e,
    0x69,
    0x6d,
    0x61,
    0x67,
    0x65,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x05,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x22,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x21,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x09,
    0x00,
    0x00,
    0x00,
    0x22,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x47,
    0x00,
    0x04,
    0x00,
    0x09,
    0x00,
    0x00,
    0x00,
    0x21,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x16,
    0x00,
    0x03,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x00,
    0x00,
    0x2b,
    0x00,
    0x04,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x20,
    0x41,
    0x2b,
    0x00,
    0x04,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x3f,
    0x19,
    0x00,
    0x09,
    0x00,
    0x06,
    0x00,
    0x00,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x04,
    0x00,
    0x0e,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x06,
    0x00,
    0x00,
    0x00,
    0x1a,
    0x00,
    0x02,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x04,
    0x00,
    0x0f,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x17,
    0x00,
    0x04,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x04,
    0x00,
    0x11,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x17,
    0x00,
    0x04,
    0x00,
    0x12,
    0x00,
    0x00,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x04,
    0x00,
    0x13,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x12,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x04,
    0x00,
    0x14,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x13,
    0x00,
    0x02,
    0x00,
    0x15,
    0x00,
    0x00,
    0x00,
    0x21,
    0x00,
    0x03,
    0x00,
    0x16,
    0x00,
    0x00,
    0x00,
    0x15,
    0x00,
    0x00,
    0x00,
    0x1b,
    0x00,
    0x03,
    0x00,
    0x0a,
    0x00,
    0x00,
    0x00,
    0x06,
    0x00,
    0x00,
    0x00,
    0x3b,
    0x00,
    0x04,
    0x00,
    0x0e,
    0x00,
    0x00,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x3b,
    0x00,
    0x04,
    0x00,
    0x0f,
    0x00,
    0x00,
    0x00,
    0x09,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x3b,
    0x00,
    0x04,
    0x00,
    0x11,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x3b,
    0x00,
    0x04,
    0x00,
    0x13,
    0x00,
    0x00,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x3b,
    0x00,
    0x04,
    0x00,
    0x14,
    0x00,
    0x00,
    0x00,
    0x05,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x36,
    0x00,
    0x05,
    0x00,
    0x15,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x16,
    0x00,
    0x00,
    0x00,
    0xf8,
    0x00,
    0x02,
    0x00,
    0x17,
    0x00,
    0x00,
    0x00,
    0x3d,
    0x00,
    0x04,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x18,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x3d,
    0x00,
    0x04,
    0x00,
    0x12,
    0x00,
    0x00,
    0x00,
    0x19,
    0x00,
    0x00,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x3d,
    0x00,
    0x04,
    0x00,
    0x06,
    0x00,
    0x00,
    0x00,
    0x1a,
    0x00,
    0x00,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x3d,
    0x00,
    0x04,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x1b,
    0x00,
    0x00,
    0x00,
    0x09,
    0x00,
    0x00,
    0x00,
    0x56,
    0x00,
    0x05,
    0x00,
    0x0a,
    0x00,
    0x00,
    0x00,
    0x1c,
    0x00,
    0x00,
    0x00,
    0x1a,
    0x00,
    0x00,
    0x00,
    0x1b,
    0x00,
    0x00,
    0x00,
    0x57,
    0x00,
    0x06,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x1d,
    0x00,
    0x00,
    0x00,
    0x1c,
    0x00,
    0x00,
    0x00,
    0x19,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x1d,
    0x00,
    0x00,
    0x00,
    0x18,
    0x00,
    0x00,
    0x00,
    0x51,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x1f,
    0x00,
    0x00,
    0x00,
    0x19,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x00,
    0x00,
    0x1f,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x06,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x21,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x20,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x22,
    0x00,
    0x00,
    0x00,
    0x21,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x81,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x23,
    0x00,
    0x00,
    0x00,
    0x22,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x51,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x24,
    0x00,
    0x00,
    0x00,
    0x19,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x25,
    0x00,
    0x00,
    0x00,
    0x24,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x06,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x26,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x25,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x27,
    0x00,
    0x00,
    0x00,
    0x26,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x81,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x28,
    0x00,
    0x00,
    0x00,
    0x27,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x81,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x29,
    0x00,
    0x00,
    0x00,
    0x1f,
    0x00,
    0x00,
    0x00,
    0x24,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x2a,
    0x00,
    0x00,
    0x00,
    0x29,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x00,
    0x06,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x2b,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x2a,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x2c,
    0x00,
    0x00,
    0x00,
    0x2b,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x81,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x2d,
    0x00,
    0x00,
    0x00,
    0x2c,
    0x00,
    0x00,
    0x00,
    0x0d,
    0x00,
    0x00,
    0x00,
    0x51,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x2e,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x2f,
    0x00,
    0x00,
    0x00,
    0x2e,
    0x00,
    0x00,
    0x00,
    0x23,
    0x00,
    0x00,
    0x00,
    0x51,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x30,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x31,
    0x00,
    0x00,
    0x00,
    0x30,
    0x00,
    0x00,
    0x00,
    0x28,
    0x00,
    0x00,
    0x00,
    0x51,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x32,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x85,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x33,
    0x00,
    0x00,
    0x00,
    0x32,
    0x00,
    0x00,
    0x00,
    0x2d,
    0x00,
    0x00,
    0x00,
    0x51,
    0x00,
    0x05,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x34,
    0x00,
    0x00,
    0x00,
    0x1e,
    0x00,
    0x00,
    0x00,
    0x03,
    0x00,
    0x00,
    0x00,
    0x50,
    0x00,
    0x07,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x35,
    0x00,
    0x00,
    0x00,
    0x2f,
    0x00,
    0x00,
    0x00,
    0x31,
    0x00,
    0x00,
    0x00,
    0x33,
    0x00,
    0x00,
    0x00,
    0x34,
    0x00,
    0x00,
    0x00,
    0x3e,
    0x00,
    0x03,
    0x00,
    0x05,
    0x00,
    0x00,
    0x00,
    0x35,
    0x00,
    0x00,
    0x00,
    0xfd,
    0x00,
    0x01,
    0x00,
    0x38,
    0x00,
    0x01,
    0x00,
};
static const unsigned int testgpu_effects_grayscale_frag_spv_len = 1412;

struct FullscreenEffectData {
    const char *name;
    const unsigned char *spirv_shader_source;
    unsigned int spirv_shader_source_len;
    int num_samplers;
    int num_uniform_buffers;
    SDL_GPUShader *shader;
    SDL_GPURenderState *state;
};

struct ShaderData {
    char *spv_data;
    size_t spv_size;
};

typedef struct
{
    float texture_width;
    float texture_height;
} CRTEffectUniforms;

#define FRAGMENT_SHADER_SOURCE "shaders/fragment_shader.frag"

static shaderc_compiler_t shader_compiler = NULL;
static shaderc_compile_options_t shader_compiler_options = NULL;

bool game_init_shaders(struct Game *g) {

    g->device = (SDL_GPUDevice *)SDL_GetPointerProperty(SDL_GetRendererProperties(g->renderer), SDL_PROP_RENDERER_GPU_DEVICE_POINTER, NULL);
    if (!g->device) {
        SDL_Log("Couldn't get GPU device: %s\n", SDL_GetError());
        return false;
    }

    SDL_GPUShaderFormat formats = SDL_GetGPUShaderFormats(g->device);
    if (formats == SDL_GPU_SHADERFORMAT_INVALID) {
        SDL_Log("Couldn't get supported shader formats: %s", SDL_GetError());
        return false;
    }

    if (!(formats & SDL_GPU_SHADERFORMAT_SPIRV)) {
        SDL_Log("SPIR-V shader format not supported");
        return false;
    }

    shader_compiler = shaderc_compiler_initialize();
     shader_compiler_options = shaderc_compile_options_initialize();

    //// create crt shader

     StringView fragment_shader_source = read_file_to_string_view(FRAGMENT_SHADER_SOURCE);

     shaderc_compilation_result_t result = shaderc_compile_into_spv(
         shader_compiler, fragment_shader_source.data, fragment_shader_source.size,
         shaderc_fragment_shader, "fragment_shader.frag", "main", shader_compiler_options);

    //// free string view
     string_view_free(&fragment_shader_source);

     if (shaderc_result_get_compilation_status(result) != shaderc_compilation_status_success) {
         printf("Shader compilation failed: %s\n", shaderc_result_get_error_message(result));
         return false;
     }

     size_t spv_size = shaderc_result_get_length(result);
     const char *spv_data = shaderc_result_get_bytes(result);

    SDL_GPUShaderCreateInfo info;
    SDL_zero(info);

    info.format = SDL_GPU_SHADERFORMAT_SPIRV;
    info.code = spv_data;
    info.code_size = spv_size;
    info.entrypoint = "main";
    info.num_samplers = 1;
    info.num_uniform_buffers = 0;
    info.stage = SDL_GPU_SHADERSTAGE_FRAGMENT;

    SDL_GPUShader *shader = SDL_CreateGPUShader(g->device, &info);

    if (!shader) {
        SDL_Log("Couldn't create shader: %s", SDL_GetError());
        return false;
    }

    SDL_GPURenderStateDesc desc;
    SDL_INIT_INTERFACE(&desc);
    desc.fragment_shader = shader;
    g->render_state = SDL_CreateGPURenderState(g->renderer, &desc);
    if (!g->render_state) {
        SDL_Log("Couldn't create render state: %s", SDL_GetError());
        return false;
    }

    return true;
}
